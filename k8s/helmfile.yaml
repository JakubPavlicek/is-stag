# Helmfile for IS-STAG Infrastructure
# Usage:
#   helmfile -e qa sync        # Deploy to qa
#   helmfile -e prod sync      # Deploy to prod
#   helmfile -e qa destroy     # Destroy qa

repositories:
  - name: jetstack
    url: https://charts.jetstack.io
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: grafana
    url: https://grafana.github.io/helm-charts
  - name: prometheus-community
    url: https://prometheus-community.github.io/helm-charts
  - name: open-telemetry
    url: https://open-telemetry.github.io/opentelemetry-helm-charts
  - name: codecentric
    url: https://codecentric.github.io/helm-charts
  - name: ingress-nginx
    url: https://kubernetes.github.io/ingress-nginx

environments:
  qa:
    values:
      - namespace: is-stag-qa
  prod:
    values:
      - namespace: is-stag-prod

# Create a namespace before deploying to it
hooks:
  - events: [ "prepare" ]
    showlogs: true
    command: "bash"
    args:
      - "-c"
      - |
        kubectl apply -f - <<EOF
        apiVersion: v1
        kind: Namespace
        metadata:
          name: {{ .Environment.Values.namespace }}
        EOF

---

templates:
  .backend-service-common: &backend-service-common
    chart: ./charts/backend-service
    namespace: "{{ .Environment.Values.namespace }}"
    wait: false
    missingFileHandler: Warn
    needs:
      - opentelemetry-operator
      - redis-cache
      - keycloak
    values:
      - "infrastructure/is-stag-app/{{ .Release.Name }}/values.yaml"
      - "infrastructure/is-stag-app/{{ .Release.Name }}/values-{{ .Environment.Name }}.yaml"

helmDefaults:
  createNamespace: true
  wait: true
  waitForJobs: true
  timeout: 300

releases:
  # ========================================
  # Cert-Manager
  # ========================================
  - name: cert-manager
    chart: jetstack/cert-manager
    version: v1.19.1
    namespace: "{{ .Environment.Values.namespace }}"
    set:
      - name: crds.enabled
        value: true
    hooks:
      - events: [ "postsync" ]
        showlogs: true
        command: "kubectl"
        args:
          - "apply"
          - "-f"
          - "infrastructure/cert-manager"
          - "--namespace={{ .Environment.Values.namespace }}"

  # ========================================
  # Databases
  # ========================================
  - name: keycloak-postgresql
    chart: bitnami/postgresql
    version: 18.1.8
    namespace: "{{ .Environment.Values.namespace }}"
    values:
      - infrastructure/database/keycloak-postgresql/values.yaml
    hooks:
      - events: [ "presync" ]
        showlogs: true
        command: "kubectl"
        args:
          - "apply"
          - "-f"
          - "infrastructure/database/keycloak-postgresql/secret.yaml"
          - "--namespace={{ .Environment.Values.namespace }}"

  - name: redis-cache
    chart: bitnami/redis
    version: 23.2.12
    namespace: "{{ .Environment.Values.namespace }}"
    timeout: 600
    values:
      - infrastructure/database/redis/cache-values.yaml
    hooks:
      - events: [ "presync" ]
        showlogs: true
        command: "kubectl"
        args:
          - "apply"
          - "-f"
          - "infrastructure/database/redis/cache-secret.yaml"
          - "--namespace={{ .Environment.Values.namespace }}"

  - name: redis-rate-limiter
    chart: bitnami/redis
    version: 23.2.12
    namespace: "{{ .Environment.Values.namespace }}"
    timeout: 600
    values:
      - infrastructure/database/redis/rate-limiter-values.yaml
    hooks:
      - events: [ "presync" ]
        showlogs: true
        command: "kubectl"
        args:
          - "apply"
          - "-f"
          - "infrastructure/database/redis/rate-limiter-secret.yaml"
          - "--namespace={{ .Environment.Values.namespace }}"

  # ========================================
  # Observability Stack
  # ========================================
  - name: grafana
    chart: grafana/grafana
    version: 10.1.4
    namespace: "{{ .Environment.Values.namespace }}"
    values:
      - infrastructure/observability/grafana/values.yaml
      - infrastructure/observability/grafana/values-{{ .Environment.Name }}.yaml
    needs:
      - redis-cache
      - redis-rate-limiter
    hooks:
      - events: [ "presync" ]
        showlogs: true
        command: "kubectl"
        args:
          - "apply"
          - "-f"
          - "infrastructure/observability/grafana/secret.yaml"
          - "--namespace={{ .Environment.Values.namespace }}"

  - name: prometheus
    chart: prometheus-community/prometheus
    version: 27.45.0
    namespace: "{{ .Environment.Values.namespace }}"
    values:
      - infrastructure/observability/prometheus/values.yaml
      - infrastructure/observability/prometheus/values-{{ .Environment.Name }}.yaml

  - name: loki
    chart: grafana/loki
    version: 6.46.0
    namespace: "{{ .Environment.Values.namespace }}"
    values:
      - infrastructure/observability/loki/values.yaml

  - name: tempo
    chart: grafana/tempo
    version: 1.24.0
    namespace: "{{ .Environment.Values.namespace }}"
    values:
      - infrastructure/observability/tempo/values.yaml

  # ========================================
  # OpenTelemetry
  # ========================================
  - name: opentelemetry-operator
    chart: open-telemetry/opentelemetry-operator
    version: 0.99.0
    namespace: "{{ .Environment.Values.namespace }}"
    needs:
      - cert-manager
      - prometheus
      - loki
      - tempo
    values:
      - infrastructure/observability/opentelemetry/values.yaml
    hooks:
      - events: [ "postsync" ]
        showlogs: true
        command: "bash"
        args:
          - "-c"
          - |
            kubectl wait --for=condition=available --timeout=300s deployment/opentelemetry-operator -n {{ .Environment.Values.namespace }}
            until kubectl get endpoints opentelemetry-operator-webhook -n {{ .Environment.Values.namespace }} -o jsonpath='{.subsets}' | grep -q "addresses"; do
              sleep 5
            done
            kubectl apply -f 'infrastructure/observability/opentelemetry/otel-*.yaml' -n {{ .Environment.Values.namespace }}
            kubectl wait --for=condition=available --timeout=300s deployment/otel-collector -n {{ .Environment.Values.namespace }}

  # ========================================
  # Keycloak
  # ========================================
  - name: keycloak
    chart: codecentric/keycloakx
    version: 7.1.4
    namespace: "{{ .Environment.Values.namespace }}"
    needs:
      - opentelemetry-operator
      - keycloak-postgresql
    values:
      - infrastructure/keycloak/values.yaml

  # ========================================
  # Ingress Controller
  # ========================================
  - name: ingress-nginx
    chart: ingress-nginx/ingress-nginx
    version: 4.14.0
    namespace: "{{ .Environment.Values.namespace }}"
    wait: false
    needs:
      - cert-manager
    values:
      - infrastructure/ingress/values.yaml
    hooks:
      - events: [ "presync" ]
        showlogs: true
        command: "kubectl"
        args:
          - "apply"
          - "-f"
          - "infrastructure/ingress/ingress.yaml"
          - "--namespace={{ .Environment.Values.namespace }}"

  # ========================================
  # IS/STAG Applications
  # ========================================
  - name: react-client
    chart: ./charts/client
    namespace: "{{ .Environment.Values.namespace }}"
    wait: false
    missingFileHandler: Warn
    values:
      - infrastructure/is-stag-app/react-client/values.yaml
      - infrastructure/is-stag-app/react-client/values-{{ .Environment.Name }}.yaml
    needs:
      - keycloak

  - name: api-gateway
    <<: *backend-service-common
    needs:
      - opentelemetry-operator
      - redis-rate-limiter
      - keycloak

  - name: codelist-service
    <<: *backend-service-common

  - name: student-service
    <<: *backend-service-common

  - name: study-plan-service
    <<: *backend-service-common

  - name: user-service
    <<: *backend-service-common