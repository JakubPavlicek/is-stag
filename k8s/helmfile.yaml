# Helmfile for IS-STAG Infrastructure
# Usage:
#   helmfile -e perftest sync        # Deploy to perftest
#   helmfile -e prod sync            # Deploy to prod
#   helmfile -e perftest destroy     # Destroy perftest

repositories:
  - name: metallb
    url: https://metallb.github.io/metallb
  - name: jetstack
    url: https://charts.jetstack.io
  - name: grafana
    url: https://grafana.github.io/helm-charts
  - name: grafana-community
    url: https://grafana-community.github.io/helm-charts/
  - name: prometheus-community
    url: https://prometheus-community.github.io/helm-charts
  - name: open-telemetry
    url: https://open-telemetry.github.io/opentelemetry-helm-charts
  - name: codecentric
    url: https://codecentric.github.io/helm-charts
  - name: is-stag
    url: https://jakubpavlicek.github.io/is-stag/

environments:
  perftest:
    values:
      - namespace: is-stag-perftest
  prod:
    values:
      - namespace: is-stag-prod

# Global Namespace Management
hooks:
  # Install Gateway API CRDs
  - events: [ "prepare" ]
    showlogs: true
    command: "kubectl"
    args:
      - "apply"
      - "--server-side"
      - "-f"
      - "https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.1/standard-install.yaml"

  # Create a namespace before deploying to it
  - events: [ "prepare" ]
    showlogs: true
    command: "bash"
    args:
      - "-c"
      - |
        kubectl apply -f - <<EOF
        apiVersion: v1
        kind: Namespace
        metadata:
          name: {{ .Environment.Values.namespace }}
        EOF

---

templates:
  .backend-service-common: &backend-service-common
    chart: is-stag/backend-service
    version: 0.0.2
    namespace: "{{ .Environment.Values.namespace }}"
    wait: false
    missingFileHandler: Warn
    needs:
      - secrets
      - otel-config
      - redis-cache
      - keycloak
    secrets:
      - secrets/oracle-secrets.yaml
    values:
      - "is-stag/{{ .Release.Name }}/values.yaml"
      - "is-stag/{{ .Release.Name }}/values-{{ .Environment.Name }}.yaml"

helmDefaults:
  createNamespace: true
  wait: true
  waitForJobs: true
  timeout: 300

releases:
  # ========================================
  # Secrets
  # ========================================
  - name: secrets
    chart: is-stag/secrets
    version: 0.0.2
    namespace: "{{ .Environment.Values.namespace }}"
    secrets:
      - secrets/secrets.yaml

  # ========================================
  # MetalLB
  # ========================================
  - name: metallb
    chart: metallb/metallb
    version: 0.15.3
    namespace: "{{ .Environment.Values.namespace }}"
    values:
      - metallb/values.yaml

  - name: metallb-config
    chart: is-stag/metallb-config
    version: 0.0.2
    namespace: "{{ .Environment.Values.namespace }}"
    needs:
      - metallb
    values:
      - metallb-config/values.yaml

  # ========================================
  # Cert-Manager
  # ========================================
  - name: cert-manager
    chart: jetstack/cert-manager
    version: v1.19.3
    namespace: "{{ .Environment.Values.namespace }}"
    values:
      - cert-manager/values.yaml

  - name: cert-manager-config
    chart: is-stag/cert-manager-config
    version: 0.0.2
    namespace: "{{ .Environment.Values.namespace }}"
    needs:
      - cert-manager
    values:
      - cert-manager-config/values.yaml

  # ========================================
  # Databases
  # ========================================
  - name: keycloak-postgresql
    chart: oci://registry-1.docker.io/bitnamicharts/postgresql
    version: 18.2.4
    namespace: "{{ .Environment.Values.namespace }}"
    values:
      - database/keycloak-postgresql/values.yaml
    needs:
      - secrets

  - name: redis-cache
    chart: oci://registry-1.docker.io/bitnamicharts/redis
    version: 24.1.3
    namespace: "{{ .Environment.Values.namespace }}"
    timeout: 600
    values:
      - database/redis/cache-values.yaml
    needs:
      - secrets

  - name: redis-rate-limiter
    chart: oci://registry-1.docker.io/bitnamicharts/redis
    version: 24.1.3
    namespace: "{{ .Environment.Values.namespace }}"
    timeout: 600
    values:
      - database/redis/rate-limiter-values.yaml
    needs:
      - secrets

  # ========================================
  # Observability Stack
  # ========================================
  - name: prometheus
    chart: prometheus-community/prometheus
    version: 28.7.0
    namespace: "{{ .Environment.Values.namespace }}"
    missingFileHandler: Warn
    values:
      - observability/prometheus/values.yaml
      - observability/prometheus/values-{{ .Environment.Name }}.yaml

  - name: loki
    chart: grafana/loki
    version: 6.51.0
    namespace: "{{ .Environment.Values.namespace }}"
    values:
      - observability/loki/values.yaml

  - name: tempo
    chart: grafana-community/tempo
    version: 1.26.1
    namespace: "{{ .Environment.Values.namespace }}"
    values:
      - observability/tempo/values.yaml

  - name: grafana
    chart: grafana-community/grafana
    version: 11.0.1
    namespace: "{{ .Environment.Values.namespace }}"
    wait: false
    missingFileHandler: Warn
    values:
      - observability/grafana/values.yaml
      - observability/grafana/values-{{ .Environment.Name }}.yaml
    needs:
      - redis-cache
      - redis-rate-limiter
      - secrets

  # ========================================
  # OpenTelemetry
  # ========================================
  - name: opentelemetry-operator
    chart: open-telemetry/opentelemetry-operator
    version: 0.105.0
    namespace: "{{ .Environment.Values.namespace }}"
    needs:
      - cert-manager-config
      - prometheus
      - loki
      - tempo
    values:
      - observability/opentelemetry/values.yaml
    hooks:
      - events: [ "postsync" ]
        showlogs: true
        command: "bash"
        args:
          - "-c"
          - |
            echo "Waiting for OpenTelemetry operator webhook to be ready..."
            kubectl wait --for=condition=available --timeout=300s \
              deployment/opentelemetry-operator-controller-manager \
              -n {{ .Environment.Values.namespace }}
            
            echo "Waiting for webhook service endpoint to be ready..."
            for i in {1..60}; do
              if kubectl get endpoints opentelemetry-operator-webhook -n {{ .Environment.Values.namespace }} -o jsonpath='{.subsets[*].addresses[*].ip}' | grep -q .; then
                echo "Webhook endpoint is ready"
                sleep 5
                exit 0
              fi
              echo "Waiting for webhook endpoint... ($i/60)"
              sleep 5
            done
            echo "Timeout waiting for webhook endpoint"
            exit 1

  - name: otel-config
    chart: is-stag/otel-config
    version: 0.0.2
    namespace: "{{ .Environment.Values.namespace }}"
    needs:
      - opentelemetry-operator
    values:
      - otel-config/values.yaml

  # ========================================
  # Keycloak
  # ========================================
  - name: keycloak
    chart: codecentric/keycloakx
    version: 7.1.7
    namespace: "{{ .Environment.Values.namespace }}"
    needs:
      - otel-config
      - keycloak-postgresql
      - secrets
    values:
      - keycloak/values.yaml

  # ========================================
  # NGINX Gateway Fabric
  # ========================================
  - name: nginx-gateway-fabric
    chart: oci://ghcr.io/nginx/charts/nginx-gateway-fabric
    version: 2.4.0
    namespace: "{{ .Environment.Values.namespace }}"
    wait: false
    values:
      - gateway/values.yaml
    needs:
      - cert-manager-config

  - name: gateway-config
    chart: is-stag/gateway-config
    version: 0.0.2
    namespace: "{{ .Environment.Values.namespace }}"
    needs:
      - nginx-gateway-fabric
    values:
      - gateway-config/values.yaml
    hooks:
      - events: [ "postuninstall" ]
        showlogs: true
        command: "sleep"
        args:
          - "30"

  # ========================================
  # IS/STAG Applications
  # ========================================
  - name: react-client
    chart: is-stag/client
    version: 0.0.2
    namespace: "{{ .Environment.Values.namespace }}"
    wait: false
    missingFileHandler: Warn
    values:
      - is-stag/react-client/values.yaml
      - is-stag/react-client/values-{{ .Environment.Name }}.yaml
    needs:
      - gateway-config
      - keycloak

  - name: api-gateway
    <<: *backend-service-common
    needs:
      - secrets
      - otel-config
      - gateway-config
      - keycloak

  - name: codelist-service
    <<: *backend-service-common

  - name: student-service
    <<: *backend-service-common

  - name: study-plan-service
    <<: *backend-service-common

  - name: user-service
    <<: *backend-service-common
